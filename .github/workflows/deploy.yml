name: Deploy to Lightsail

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: main-aws

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ secrets.LIGHTSAIL_USER }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          script: |
            set -euo pipefail

            DEPLOY_DIR="${{ secrets.DEPLOY_PATH }}"
            cd "$DEPLOY_DIR"

            echo "==> Pulling latest code from main..."
            git fetch origin main
            git reset --hard origin/main

            echo "==> Stopping all project containers..."
            docker compose down --remove-orphans || true
            docker compose -f docker-compose.yml -f docker-compose.prod.yml down --remove-orphans || true

            echo "==> Killing any process holding ports 3000/5173..."
            sudo fuser -k 3000/tcp 2>/dev/null || true
            sudo fuser -k 5173/tcp 2>/dev/null || true
            sleep 2

            echo "==> Rebuilding Docker images..."
            docker compose -f docker-compose.yml -f docker-compose.prod.yml build --no-cache

            echo "==> Starting containers..."
            docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d

            echo "==> Cleaning up dangling images..."
            docker image prune -f

            echo "==> Deploy complete!"
